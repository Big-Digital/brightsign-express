"use strict";(self.webpackChunkGameClient=self.webpackChunkGameClient||[]).push([[4324],{4324:(e,t,i)=>{i.d(t,{EXT_lights_ies:()=>l});var r=i(4049),o=i(451),s=i(8310),n=i(9838),h=i(67),a=i(9046),u=i(35);const c="EXT_lights_ies";class l{constructor(e){this.name=c,this._loader=e,this.enabled=this._loader.isExtensionUsed(c)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,h.l2.Assign(this._lights)}}loadNodeAsync(e,t,i){return h.BT.LoadExtensionAsync(e,t,this.name,(async(a,c)=>{let l,_;this._loader._allMaterialsDirtyRequired=!0;const x=await this._loader.loadNodeAsync(e,t,(e=>{_=h.l2.Get(a,this._lights,c.light);const t=_.name||e.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l=new s.n(t,r.Pq.Zero(),r.Pq.Backward(),0,1,this._loader.babylonScene),l.angle=Math.PI/2,l.innerAngle=0,l._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,_._babylonLight=l,l.falloffType=n.v.FALLOFF_GLTF,l.diffuse=c.color?o.v9.FromArray(c.color):o.v9.White(),l.intensity=c.multiplier||1,l.range=Number.MAX_VALUE,l.parent=e,this._loader._babylonLights.push(l),h.BT.AddPointerMetadata(l,a),i(e)}));let p;if(_.uri)p=await this._loader.loadUriAsync(e,_,_.uri);else{const t=h.l2.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,_.bufferView);p=await this._loader.loadBufferViewAsync(`/bufferViews/${t.index}`,t)}return l.iesProfileTexture=new u.g(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,p,!0,void 0,void 0,void 0,void 0,".ies"),x}))}}(0,a.Hg)(c),(0,a.Ye)(c,!0,(e=>new l(e)))},8310:(e,t,i)=>{i.d(t,{n:()=>l});var r=i(4754),o=i(4537),s=i(4049),n=i(4292),h=i(9838),a=i(470),u=i(35),c=i(5686);n.b.AddNodeConstructor("Light_Type_2",((e,t)=>()=>new l(e,s.Pq.Zero(),s.Pq.Zero(),0,0,t)));class l extends a.p{get iesProfileTexture(){return this._iesProfileTexture}set iesProfileTexture(e){this._iesProfileTexture!==e&&(this._iesProfileTexture=e,this._iesProfileTexture&&l._IsTexture(this._iesProfileTexture)&&this._iesProfileTexture.onLoadObservable.addOnce((()=>{this._markMeshesAsLightDirty()})))}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(l._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled((()=>{this._markMeshesAsLightDirty()})):l._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce((()=>{this._markMeshesAsLightDirty()}))))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,o,n){super(e,n),this._innerAngle=0,this._iesProfileTexture=null,this._projectionTextureMatrix=s.uq.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=s.Pq.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=s.Pq.Zero(),this._projectionTextureViewLightMatrix=s.uq.Zero(),this._projectionTextureProjectionLightMatrix=s.uq.Zero(),this._projectionTextureScalingMatrix=s.uq.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=o}getClassName(){return"SpotLight"}getTypeID(){return h.v.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;const o=this._shadowAngleScale*this._angle,n=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,h=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;s.uq.PerspectiveFovLHToRef(o,1,a?h:n,a?n:h,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),s.uq.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,o=1/Math.tan(this._angle/2);s.uq.FromValuesToRef(o/1,0,0,0,0,o,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof u.g){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;s.uq.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this._iesProfileTexture&&this._iesProfileTexture.isReady()&&e.setTexture("iesLightTexture"+t,this._iesProfileTexture),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=s.Pq.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=s.Pq.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return i=this.computeTransformedInformation()?s.Pq.Normalize(this.transformedDirection):s.Pq.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose(),this._iesProfileTexture&&(this._iesProfileTexture.dispose(),this._iesProfileTexture=null)}getDepthMinZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:e?.minZ??0;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMaxZ?this.shadowMaxZ:e?.maxZ??1e4;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady()),e["IESLIGHTTEXTURE"+t]=!(!this._iesProfileTexture||!this._iesProfileTexture.isReady())}}(0,r.Cg)([(0,o.lK)()],l.prototype,"angle",null),(0,r.Cg)([(0,o.lK)()],l.prototype,"innerAngle",null),(0,r.Cg)([(0,o.lK)()],l.prototype,"shadowAngleScale",null),(0,r.Cg)([(0,o.lK)()],l.prototype,"exponent",void 0),(0,r.Cg)([(0,o.lK)()],l.prototype,"projectionTextureLightNear",null),(0,r.Cg)([(0,o.lK)()],l.prototype,"projectionTextureLightFar",null),(0,r.Cg)([(0,o.lK)()],l.prototype,"projectionTextureUpDirection",null),(0,r.Cg)([(0,o.uM)("projectedLightTexture")],l.prototype,"_projectionTexture",void 0),(0,c.Y5)("BABYLON.SpotLight",l)}}]);