"use strict";(self.webpackChunkGameClient=self.webpackChunkGameClient||[]).push([[9232],{9232:(e,t,n)=>{n.d(t,{EXT_lights_image_based:()=>u});var s=n(4871),a=n(4049),r=n(979),i=n(2036),l=n(7336);class o extends l.b{constructor(e,t,n,s=5,a=0,r=!1,i=!1,l=3,o=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,n,s,a,r,i,l,o)}update(e,t,n,s,a=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,n,s,a)}updateRGBDAsync(e,t=null,n=.8,s=0){return(0,i.gW)(this._texture,e,t,n,s).then((()=>{}))}clone(){return r.p.Clone((()=>{const e=this.getScene(),t=this._texture,n=new o(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return 13===t.source&&n.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),n}),this)}}var h=n(67),c=n(9046);const d="EXT_lights_image_based";class u{constructor(e){this.name=d,this._loader=e,this.enabled=this._loader.isExtensionUsed(d)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return h.BT.LoadExtensionAsync(e,t,this.name,((n,s)=>{this._loader._allMaterialsDirtyRequired=!0;const a=new Array;a.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);const r=h.l2.Get(`${n}/light`,this._lights,s.light);return a.push(this._loadLightAsync(`/extensions/${this.name}/lights/${s.light}`,r).then((e=>{this._loader.babylonScene.environmentTexture=e}))),this._loader.logClose(),Promise.all(a).then((()=>{}))}))}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(`${e}`);const r=new Array(t.specularImages.length);for(let s=0;s<t.specularImages.length;s++){const a=t.specularImages[s];r[s]=new Array(a.length);for(let t=0;t<a.length;t++){const i=`${e}/specularImages/${s}/${t}`;this._loader.logOpen(`${i}`);const l=a[t],o=h.l2.Get(i,this._loader.gltf.images,l);n.push(this._loader.loadImageAsync(`/images/${l}`,o).then((e=>{r[s][t]=e}))),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then((()=>{const n=new o(this._loader.babylonScene,null,t.specularImageSize);if(n.name=t.name||"environment",t._babylonTexture=n,null!=t.intensity&&(n.level=t.intensity),t.rotation){let e=a.PT.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=a.PT.Inverse(e)),a.uq.FromQuaternionToRef(e,n.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const i=s.O.FromArray(t.irradianceCoefficients);i.scaleInPlace(t.intensity),i.convertIrradianceToLambertianRadiance();const l=s.Q.FromHarmonics(i),h=(r.length-1)/Math.log2(t.specularImageSize);return n.updateRGBDAsync(r,l,h)}))}return t._loaded.then((()=>t._babylonTexture))}}(0,c.Hg)(d),(0,c.Ye)(d,!0,(e=>new u(e)))}}]);